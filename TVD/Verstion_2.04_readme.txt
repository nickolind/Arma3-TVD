TVD mod
by Nickorr

-------------------------------------------

План построения / настройки миссии на ТВД:

1. Создать маркеры-зоны для захвата/удержания, назвать маркеры mZone_0, mZone_1 и т.д., в поле Text маркера вписать человеческое название зоны (отображается в дебриф-окне)


2. К каждой зоне привязать модуль WMT Point
	Если в поле "Изначальная сторона-владелец" указать сторону, не являющуюся одной из двух противоборствующих сторон, то зона будет отмечена как изначально нейтральная и никому изначального преимущества не добавит.
	Если включить параметр "Locked", то при отступлении стороны-владельца зоны, зона не будет передаваться врагу.

3. Прописать ценность важным юнитам (10 это обычный боец, 20 - комод, 40 - взводный, 100 - кс и тд) в ините:
	- Ценная техника - this setVariable ["TVD_UnitValue",[west,200]];
	- Командир стороны - this setVariable ["TVD_UnitValue",[west,100,"sideLeader"]];
	- КО (взводные в том числе - просто вместо 20 выставить 40) - this setVariable ["TVD_UnitValue",[west,20]];
	- Экипаж(БМП/Танк) (обычно =30) - this setVariable ["TVD_UnitValue",[west,30,"crewTank"]];
	- Экипаж(БТР) (обычно =10) - this setVariable ["TVD_UnitValue",[west,10,"crewAPC"]];
	- Пилот (обычно =50) - this setVariable ["TVD_UnitValue",[west,50,"pilot"]];
	- Снайпер (обычно =30) - this setVariable ["TVD_UnitValue",[west,30,"sniper"]];
	- Спец-юнит (ценность - произвольно, это широкий класс ценных юнитов (с подсветкой смерти в лог)) - this setVariable ["TVD_UnitValue",[west,666,"VIP"]];
	- Ценный солдат (о его смерти не пишется в лог) - this setVariable ["TVD_UnitValue",[west,40,"soldier"]];
Значение ценности должно быть кратным 2.
Для техники (ТОЛЬКО ДЛЯ ТЕХНИКИ) значение стороны можно вписывать 'sideLogic'. Тогда техника будет изначально нейтральной и в последствии даст бонус преимущества той стороне, что ее захватит (сторона получит 50% от значения ценности).

4. Создать тыловую зону для каждой стороны, куда они смогут отступить.
	Тыловая база (куда отступать) должна быть обрамлена триггером. Name триггера должен быть: 
	для стороны 0 - trgBase_side0
	для стороны 1 - trgBase_side1


5. Вызов из init.sqf:

5.1. Обозначить объекты-задачи (если имеются). Для этого init.sqf ПЕРЕД вызовом основного блока прописать:
	myObjectName1 setVariable ["TVD_TaskObject", [west, 500, "Грады уничтожены", true, ["false", "false", "false", "false"], false]];
	
	myObjectName1 setVariable ["TVD_TaskObject", [west, 500, "Грады уничтожены"]];	// Короткая форма (неуказанные параметры будут выставлены как в полной форме)
	
	^ для каждого объекта-задачи.
	
	Где в setVariable:
	0 - сторона, которой назначена задача
	1 - цена вопроса
	2 - сообщение выполненной задачи
	3 - выводить ли всем сообщение о выполненной задаче
	4 - авто-завершение (задача выполнена) при завершении миссии [
															по времени , 
															по потерям другой стороны , 
															при отступлении другой стороны, 
															при выполнении какой-либо из сторон основной задачи
															]
	5 - является ли задача КЛЮЧЕВОЙ - завершать ли миссию, при выполнении задачи (отсрочка 5 минут + 5 от КСа стороны, выполнившей задачу).
	
	Объектом может быть:
		а) Триггер
			Условие выполнения может быть произвольным. 
			Срабатывание триггера должно быть "Once / Однократно".
			Чтобы миссия завершилась, все задачи должны быть обработаны - либо выполнены, либо отменены. Для этого в своем триггере или скрипте нужно обрабатывать условие:
				
				if (timeToEnd != -1) then {
					if (условия_задачи_выполнены) then {	
						side0Task_0 setTriggerStatements ["true", "", ""];			//Условия выполнены - задача отмечается выполненной
					} else {	
						side0Task_0 setVariable ["TVD_TaskObject", nil, true];		//Условия не выполнены - задача отменяется
					};
				};
				
				При завершении миссии переменная timeToEnd принимает одно из значений:
					0 - завершение админом
					1 - завершение по времени
					2 - завершение по потерям
					3 - завершение из-за отступления одной из сторон	
				
		б) Модуль задачи WMT
			- Процедура настройки модулей ВМТ обычная. НО ОБЯЗАТЕЛЬНО все целевые модули должны быть синхронизированы с модулем Compose, в котором в параметре "Количество целей" должно стоять число 99.
			- Параметр Name WMT-модуля должен быть указан (для нашего примера это myObjectName1).
			- Параметр "Message" можно не заполнять.
			- Модуль Compose в init.sqf вызывать не надо. Имя модулю давать тоже не обязательно. Он нужен лишь для того, чтобы при выполнении ВМТ-задач миссия не завершалась.
			- При завершении миссии если задача так и не была выполнена, она автоматически отменяется. Любая задача при любой причине завершения.
			- Принудительно пометить задачу выполненной:
				side0Task_0 setVariable ["WMT_TaskEnd", true, true];
	
	Для любителей описания задач собственными скриптами:
		Отменить задачу:
			side0Task_0 setVariable ["TVD_TaskObjectStatus", "fail", true];
		
		Проверить, выполнена ли задача, можно запросом:
			(side0Task_0 getVariable "TVD_TaskObjectStatus") in ["success"]
		Проверить, отменена ли задача, можно запросом:
			(side0Task_0 getVariable "TVD_TaskObjectStatus") in ["fail"]
		Проверить, актуальна ли еще задача, можно запросом:
			(side0Task_0 getVariable "TVD_TaskObjectStatus") in ["success","fail"]
	
5.2. Далее вызвать основной блок:
	null = [
		sides, 				// - выставить стороны [Сторона0, Сторона1]
		capZonesCount, 		// - (не обязательно) указать количество захватываемых зон (0 - если нет зон). Зоны - в виде маркеров с Name - mZone_0 .. mZone_N-1 ).
		RetreatPossible, 	// - (не обязательно) имеет ли сторона возможность отступить. true - может, false - нет. порядок - [east, west, resistance]
		ZoneGain, 			// - (не обязательно) выставить цену одной зоны (не важно если TVD_capZonesCount = 0 ) 
		RetreatRatio		// - (не обязательно) порог потерь, начиная с которого стороне можно будет отступить
	] spawn compileFinal preprocessFileLineNumbers "TVD\TVD_Main.sqf";

------------------------------------------
	Пример со значениями по умолчанию:

	null = [
		[west, east], 
		0, 
		[true,true,true], 	// [east, west, resistance]
		50, 
		0.9
	] spawn compileFinal preprocessFileLineNumbers "TVD\TVD_Main.sqf";
------------------------------------------
	Пример с минимальными настройками (не указанные будут как в примере выше):

	null = [ [west, east] ] spawn compileFinal preprocessFileLineNumbers "TVD\TVD_Main.sqf";
------------------------------------------

6. Дополнительные скрипты TVD_Ext:
	Если нужны скрипты из папки TVD_Ext - первым делом подключить управляющий скрипт из init.sqf строкой:
		[] call compileFinal preprocessFileLineNumbers "TVD_Ext\TVD_fnc_init.sqf"
		
6.1. TVD_fnc_markBox.sqf
Если нужно подсветить на карте ящик (по образу WMT-маркеров на технику на старте), то в ините ящика вписать:
	
	this setVariable ["TVD_markBox", [west,"Ящик с Javelin + 2 ракеты"]];
-- первый параметр - сторона, которая увидит маркер. Второй - текст маркера.

6.2 TVD_frisk.sqf
Возможность лазить в инвентарь пленников и бойцов в бессознанке. Все работает автоматически.





-------------------------------------------
CHANGELOG:
2.04:
+ Сообщения от ТВД логики теперь дублируются и для куратора
+ Сообщения лога ТВД теперь дублируются в лог куратора

2.03:
* Ранги побед теперь: 4-12-36%
* Задержка в 10 сек перед срабатыванием триггера на уничтожение группы -> TVD_Init:250, TVD_util_MissionLogWriter:118
* Стационарное вооружение теперь корректно отслеживается, даже если на фриз-тайме было разобрано.

2.02:
* timeToEnd теперь броадкастится - теперь у КСа работает функция отступления.

2.01:

*Обновлен модуль HeavyLossesOverride после обновления WMT.

2.0:
* Переход на ACE3:
	Замена всех переменных - AGM_isUnconscious и AGM_isCaptive - на переменные - ACE_isUnconscious и ace_captives_ishandcuffed - соответственно (префикс "ace_captives_" может измениться)
+ TVD_util_unitRole.sqf : добавлены новые роли для интерпретации (экипажи, пилот, спец-юнит (ВИП).
* Увеличен интервал создания статус-сообщений в лог (5 -> 10 мин.).
+ Всем PlayableUnits присваивается отдельная переменная TVD_GroupID для однозначной идентификации принадлежности слота. Не меняется, даже при смене группы игровыми средствами (Join/Leave Group).
+ В записях лога теперь указывается из какого отделения боец).
+ Отдельное сообщение при отправке вражеского пленника в свой тыл ("№ пропал без вести" заменено на "№ был убит).
+ Сообщение в лог при уничтожении группы (<50% состава + убитый командир).
+ При завершении миссии, если у стороны в тыловой зоне были пленники, они автоматически отправляются в тыл стороны, а в лог идет соответствующее сообщение.
* Переработана система завершения миссии. Теперь при всех сценариях завершения (кроме завершения по времени и, временно - отступлении стороны), миссия завершается не сразу, а через 1 минуту с возможностью КСу несколько раз продлить ее на 5 минут, но не более установленного картоделом регламента.
* Коэффициент сильных потерь по умолчанию выставлен на 80%.
* Правка багов.


1.07b:
* Преимущественная победа при отклонении преимущества на 6% от изначального, вместо 7% (балансировка).

1.07:
* При смерти, в retreatSoldierAction, выход из циклов waitUntil