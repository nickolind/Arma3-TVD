TVD mod
by Nickorr

-------------------------------------------

План построения / настройки миссии на ТВД:

1. Создать маркеры-зоны для захвата/удержания, назвать маркеры mZone_0, mZone_1 и т.д., в поле Text маркера вписать человеческое название зоны (отображается в дебриф-окне)

2. К каждой зоне привязать модуль WMT Point

3. Прописать ценность важным юнитам (10 это обычный боец, 20 - комод, 40 - взводный, 100 - кс и тд) в ините:
	- Ценная техника - this setVariable ["TVD_UnitValue",[west,200]];
	- Командир стороны - this setVariable ["TVD_UnitValue",[west,100,"sideLeader"]];
	- КО (взводные в том числе - просто вместо 20 выставить 40) - this setVariable ["TVD_UnitValue",[west,20]];
	- Ценный солдат (не командир - о его смерти не пишется в лог) - this setVariable ["TVD_UnitValue",[west,40,"soldier"]];
Значение должно быть кратным 2.

4. Создать тыловую зону для каждой стороны, куда они смогут отступить.
	Тыловая база (куда отступать) должна быть обрамлена триггером. Name триггера должен быть: 
	для стороны 0 - trgBase_side0
	для стороны 1 - trgBase_side1


5. Вызов из init.sqf:

5.1. Обозначить объекты-задачи (если имеются). Для этого init.sqf ПЕРЕД вызовом основного блока прописать:
	myObjectName1 setVariable ["TVD_TaskObject", [west, 500, "Грады уничтожены", true, [0,0,0]]];
	
	^ для каждого объекта-задачи.
	
	Где в setVariable:
	0 - сторона, которой назначена задача
	1 - цена вопроса
	2 - сообщение выполненной задачи
	3 - выводить ли всем сообщение о выполненной задаче
	4 - авто-завершение при завершении [по-времени , по-потерям , при-отступлении]
	
	Объектом может быть:
		а) Триггер
			Условие выполнения может быть произвольным. 
			Срабатывание триггера должно быть "Once / Однократно".
			Чтобы миссия завершилась, все задачи должны быть обработаны - либо выполнены, либо отменены. Для этого в своем триггере или скрипте нужно обрабатывать условие:
				
				if (timeToEnd != -1) then {
					if (условия_задачи_выполнены) then {	
						taskTriggerName setTriggerStatements ["true", "", ""];			//Условия выполнены - задача отмечается выполненной
					} else {	
						taskWin_side1 setVariable ["TVD_TaskObject", nil, true];		//Условия не выполнены - задача отменяется
					};
				};
				
				При завершении миссии переменная timeToEnd принимает одно из значений:
					0 - завершение админом
					1 - завершение по времени
					2 - завершение по потерям
					3 - завершение из-за отступления одной из сторон	
				
		б) Модуль задачи WMT
			- Процедура настройки модулей ВМТ обычная. НО ОБЯЗАТЕЛЬНО все целевые модули должны быть синхронизированы с модулем Compose, в котором в параметре "Количество целей" должно стоять число 99.
			- Параметр "Message" можно не заполнять.
			- Модуль Compose в init.sqf вызывать не надо. Имя модулю давать тоже не обязательно. Он нужен лишь для того, чтобы при выполнении ВМТ-задач миссия не завершалась.
			- При завершении миссии если задача так и не была выполнена, она автоматически отменяется. Любая задача при любой причине завершения.
		
	
5.2. Далее вызвать основной блок:
	null = [
		sides, 				// - выставить стороны [Сторона0, Сторона1]
		capZonesCount, 		// - (не обязательно) указать количество захватываемых зон (0 - если нет зон). Зоны - в виде маркеров с Name - mZone_0 .. mZone_N-1 ).
		RetreatPossible, 	// - (не обязательно) порог потерь, начиная с которого стороне можно будет отступить
		ZoneGain, 			// - (не обязательно) имеет ли сторона возможность отступить. true - может, false - нет. порядок - [east, west, resistance]
		RetreatRatio		// - (не обязательно) выставить цену одной зоны (не важно если TVD_capZonesCount = 0 )
	] spawn compileFinal preprocessFileLineNumbers "TVD\TVD_Main.sqf";
	
	Пример:
	[west, 500, "Уничтожить Грады"]
------------------------------------------
	Пример со значениями по умолчанию:

	null = [
		[west, east], 
		0, 
		[true,true,true], 
		50, 
		0.75
	] spawn compileFinal preprocessFileLineNumbers "TVD\TVD_Main.sqf";
------------------------------------------
	Пример с минимальными настройками (не указанные будут как в примере выше):

	null = [ [west, east] ] spawn compileFinal preprocessFileLineNumbers "TVD\TVD_Main.sqf";
------------------------------------------

6. Дополнительные скрипты TVD_Ext:
	Подключать из init.sqf строкой:
		[] call compileFinal preprocessFileLineNumbers "TVD_Ext\TVD_fnc_init.sqf"
		
6.1. TVD_fnc_markBox.sqf
Если нужно подсветить на карте ящик (по образу ВМТ-маркеров на технику на старте), то в ините ящика вписать:
	
	this setVariable ["TVD_markBox", [west,"Ящик с Javelin + 2 ракеты"]];
-- первый параметр - сторона, которая увидит маркер. Второй - текст маркера.







-------------------------------------------
CHANGELOG:


1.02:
* Мелкие правки в дебрифере.
* Статус пишется в лог не каждые 10, а каждые 5 минут.
* Убраны сообщения о смерти КО.
* При смерти КСа сообщение об этом теперь получает каждый боец стороны (а не только КО). Если заменить некому - сторона уведомляется, что КСа больше нет.
+ Добавлен TVD_TasksKeeper - контроль состояния задач. Поддерживаются два типа задания задачи: модулями ВМТ или триггером. При завершении миссии все задачи последний раз проверяются и либо отмечаются выполненными, либо отменяются.
+ Добавлена обработка завершения миссии по потерям стороны. Миссия не завершается мгновенно - игрокам дается от 2х до 5ти минут на то чтобы попытаться выполнить невыполненные задачи и получить больше преимущества. Сторона-победитель получает уведомление о том, что противник понес потери и таймер до конца (стандартно - 5 минут, если у стороны-победителя остались невыполненные задачи, иначе 2 минуты. Если у стороны есть КС/исп.КС, то он может продлить время на еще +5 минут). Сторона, понесшая потери никаких уведомлений не получает.


1.01:
+ Добавлена папка с доп. скриптами - TVD_Ext. Из ТВД_мейн автоматом вызывается скрипт Инит из этой папки.
+ Добавлен скрипт markBox.sqf, ставящий маркер на ящик с заданным параметром в ините: this setVariable ["TVD_markBox", [west,"Ящик с Javelin + 2 ракеты"]];
+ Если помечать солдата this setVariable ["TVD_UnitValue",[west,40,"soldier"]]; - он не будет при смерти светиться в логе. Полезно, если нужно сделать отделение подороже, но не спамить в лог при каждой смерти обычных бойцов, хоть и более дорогих.
* Улучшен алгоритм определения победителя - теперь учет не того, сколько сторона потеряла в % соотношении, а учет того, сколько сторона нанесла вреда врагу (таким образом сглаживается перекос в случае если одна сторона по очкам на старте оказалась мощнее другой).
* Процентные доли перевеса для победы теперь: 7 (слабая), 12 (средняя), 22 (сильная).
+ В лог теперь заносятся события: при захвате техники врага, статус миссии каждые 10 минут.
+ При потере ценного бойца в логе в скобках теперь пишется его роль.
+ При отступлении запись в логе обо всех потерях стороны при отступлении (перед сообщение о компенсированном преимуществе). Запись о потере техники при отступлении убрана.
+ В лог РПТ теперь пишется: причина завершения миссии, кол-во живых/мертвых бойцов.

1.0:
+ Реализован учет захваченных в плен вражеских солдат - "пленным" считается боец, связанный и находящийся в тыловой зоне вражеской стороны.
+ Реализована отправка пленных в тыл стороны.
+ В лог событий добавлен вывод соотношения сторон на момент свершения какого-либо события.
* Уменьшена на 5% необходимая разница в преимуществе для достижения победы одной из сторон.
* TVD_HeavyLossesOverride - дополнительно локальные переменные отмечены в private.
* Вписан TVD_hl_ratio по умолчанию - больше не нужно указывать в ините.
* В логе вместо "X был убит" теперь пишется "X пропал без вести", подразумевая смерть ИЛИ захват в плен врагом.
* Задание параметров платформы вынесено в аргументы при вызове TVD_Main.sqf в Init.sqf.
* Больше не нужно прописывать wmt_hl_sidelimits и wmt_hl_ratio - это теперь выполняется автоматически в TVD_Main.sqf.

0.31:
* Исправлен скрипт передачи командования при смерти КСа/Исполняющего (выставлен правильный порядок для mpEventHandlers)
* Исправлен скрипт отправки техники в тыл - теперь работает
* Вызов всей платформы теперь из init.sqf

0.3:
+ Добавлена функция наследования командования при смерти КСа (передается другим взводным или КО). Если все командующие утеряны, возможность отступить - тоже утеряна.
+ Сторона теперь необязательно может иметь возможность отступить (для случаев когда по условностям миссии отступать некуда) - на усмотрение картодела.
+ Технику можно захватить - стороной-владельцем техники считается та сторона, чей боец сидит в технике. Пустая техника сохраняет принадлежность стороне того бойца, кто сидел в ней последним. Потерявшая технику сторона теряет преимущество соразмерное ценности техники. Захватившая сторона получает преимущество соразмерное половине ценности техники.
+ Технику (захваченную или собственную) можно отправить в тыл. При этом техника с карты удаляется, а ее ценность остается у стороны, отогнавшей технику в свои тылы.
+ Техника вне тыловой зоны при отступлении автоматически захватывается врагом, а не просто списывается как уничтоженная.